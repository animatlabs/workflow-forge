name: Build and Test

on:
  push:
    branches: [ main, release/2.x ]
  pull_request:
    branches: [ main, release/2.x ]
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to NuGet (true/false)'
        required: false
        default: false
        type: boolean
      version:
        description: 'Package version override (e.g. 2.1.0)'
        required: false
        type: string
      sign:
        description: 'Sign packages (true/false)'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup .NET 8.0
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.0.x

    - name: Setup .NET 10.0
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~\sonar\cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: Install SonarScanner for .NET
      run: dotnet tool install --global dotnet-sonarscanner

    - name: Restore dependencies
      run: dotnet restore WorkflowForge.sln

    - name: SonarCloud Begin
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet sonarscanner begin `
          /k:"animatlabs_workflow-forge" `
          /o:"animatlabs" `
          /d:sonar.token="$env:SONAR_TOKEN" `
          /d:sonar.host.url="https://sonarcloud.io" `
          /d:sonar.exclusions="**/src/benchmarks/**,**/src/samples/**,**/tests/**" `
          /d:sonar.coverage.exclusions="**/src/benchmarks/**,**/src/samples/**,**/tests/**"

    - name: Build
      run: dotnet build WorkflowForge.sln --configuration Release --no-restore

    - name: SonarCloud End (Static Analysis)
      continue-on-error: true
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: dotnet sonarscanner end /d:sonar.token="$env:SONAR_TOKEN"

    - name: Skip Strong Name Verification (net48)
      run: |
        & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\sn.exe" -Vr *,50cc659aecc59b65
        & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\sn.exe" -Vr *,50cc659aecc59b65

    - name: Test with Coverage
      run: |
        dotnet test WorkflowForge.sln `
          --configuration Release `
          --no-build `
          --verbosity normal `
          --logger "trx;LogFileName=test-results.trx" `
          --collect:"XPlat Code Coverage" `
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    - name: SonarCloud Begin (Coverage Import)
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet sonarscanner begin `
          /k:"animatlabs_workflow-forge" `
          /o:"animatlabs" `
          /d:sonar.token="$env:SONAR_TOKEN" `
          /d:sonar.host.url="https://sonarcloud.io" `
          /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" `
          /d:sonar.exclusions="**/src/benchmarks/**,**/src/samples/**,**/tests/**" `
          /d:sonar.coverage.exclusions="**/src/benchmarks/**,**/src/samples/**,**/tests/**"

    - name: Build for Coverage Import
      run: dotnet build WorkflowForge.sln --configuration Release --no-restore

    - name: SonarCloud End (Coverage Import)
      continue-on-error: true
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: dotnet sonarscanner end /d:sonar.token="$env:SONAR_TOKEN"

    - name: Upload test results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: test-results
        path: '**/test-results.trx'

    - name: Pack
      if: github.event_name == 'workflow_dispatch'
      run: |
        $versionArg = @()
        if ("${{ github.event.inputs.version }}") {
          $versionArg = @("-p:PackageVersion=${{ github.event.inputs.version }}")
        }
        dotnet pack WorkflowForge.sln --configuration Release --no-build --output ./packages @versionArg

    - name: Upload packages
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v6
      with:
        name: nuget-packages
        path: |
          ./packages/*.nupkg
          ./packages/*.snupkg

  publish:
    needs: build
    runs-on: windows-latest
    permissions:
      contents: read
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true'

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET 8.0
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.0.x

    - name: Setup .NET 10.0
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    - name: Download packages
      uses: actions/download-artifact@v7
      with:
        name: nuget-packages
        path: ./packages

    - name: Sign packages
      if: github.event.inputs.sign == 'true'
      env:
        SIGNING_CERT_BASE64: ${{ secrets.SIGNING_CERT_BASE64 }}
        SIGNING_CERT_PASSWORD: ${{ secrets.SIGNING_CERT_PASSWORD }}
      run: |
        $certBytes = [Convert]::FromBase64String($env:SIGNING_CERT_BASE64)
        [IO.File]::WriteAllBytes("cert.pfx", $certBytes)
        Get-ChildItem ./packages -Filter *.nupkg | ForEach-Object {
          dotnet nuget sign $_.FullName --certificate-path cert.pfx --certificate-password $env:SIGNING_CERT_PASSWORD --timestamper http://timestamp.digicert.com
        }
        Get-ChildItem ./packages -Filter *.snupkg | ForEach-Object {
          dotnet nuget sign $_.FullName --certificate-path cert.pfx --certificate-password $env:SIGNING_CERT_PASSWORD --timestamper http://timestamp.digicert.com
        }
        Remove-Item cert.pfx -Force

    - name: Push to NuGet
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        Get-ChildItem ./packages -Filter *.nupkg | ForEach-Object {
          dotnet nuget push $_.FullName --api-key $env:NUGET_API_KEY --source https://api.nuget.org/v3/index.json --skip-duplicate
        }
        Get-ChildItem ./packages -Filter *.snupkg | ForEach-Object {
          dotnet nuget push $_.FullName --api-key $env:NUGET_API_KEY --source https://api.nuget.org/v3/index.json --skip-duplicate
        }
